def builds = []
def desiredVersion = ${ROLLBACK_VERSION}
pipeline {
    environment {
        isRollbackSuccess = ''
    }
    agent any
    tools {
      maven 'maven'
      jdk 'jdk1.8.0'
    }
    stages {
        stage('FindSuccessfullBuilds') {
            steps {
                script  {

                  def job = jenkins.model.Jenkins.instance.getItem("simple-dataops-rollback")
                  job.builds.each {
                      def build = it
                      if (it.getResult().toString().equals("SUCCESS")) {
                          it.badgeActions.each {
                                   builds.add(build.displayName[1..-1])
                           }
                      }
                  }

                  builds.unique();
                  println builds
                }
            }
        }
        stage('RollbackSQLForSuccessfulBuilds') {
            steps   {
                script  {
                    println builds
                    
                    for (build in builds)    {
                        if (build != desiredVersion)   {
                            print "rolling back build "
                            println build
                        } else  {
                        println "All scripts rolled back"
                            break
                        }
                    }
                }
            }
        }
    }
}
